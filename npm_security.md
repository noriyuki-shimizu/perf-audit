# npmセキュリティ強化: 認証とトークン管理の重要な変更点

## 概要

GitHubは2025年9月29日、npmのセキュリティを強化するため、認証とトークン管理に関する重要な変更を発表しました。これらの変更は、サプライチェーン攻撃からエコシステムを保護することを目的としています。

## 主要な変更点

### 1. 粒度の細かいnpmアクセストークン(Granular Access Tokens)の有効期限制限

**新しい書き込み可能なトークンの制限:**
- **デフォルト有効期間**: 30日 → **7日**に短縮
- **最大有効期間**: 無制限 → **90日**に制限

**理由:**
- 長寿命トークンはサプライチェーン攻撃の主要な侵入経路
- トークンの有効期間を制限することでセキュリティリスクを軽減

### 2. クラシックnpmトークン(Legacy Tokens)の完全廃止

**変更内容:**
- 既存のレガシートークンを全て取り消し
- npmjs.comでのクラシックトークン生成機能を永久に無効化

**影響:**
- 古いトークン形式を使用しているCI/CDパイプラインやワークフローが影響を受ける
- 新しい粒度の細かいトークンへの移行が必須

### 3. TOTP 2FA設定の段階的廃止

**変更内容:**
- 新規TOTP(Time-based One-Time Password)設定を永久に無効化
- 既存のTOTP設定は段階的に廃止予定

**推奨される代替手段:**
- **WebAuthn/パスキー**: より安全で現代的な認証方式
- フィッシング攻撃に対する耐性が高い

## 実施タイムライン

| 時期 | 変更内容 |
|------|---------|
| **現在** | 警告メッセージの表示開始 |
| **2025年10月初旬** | • 新しいトークン有効期限制限の適用開始<br>• TOTP設定の無効化 |
| **2025年11月中旬** | クラシックトークンの完全廃止 |

## 影響を受けるユーザー

- クラシックnpmトークンを使用しているCI/CDワークフロー
- 長期間有効なトークンに依存している自動化システム
- TOTPベースの2FAを使用している開発者

## 必要なアクション

### 1. トークンの移行

**即座に実施すべきこと:**
```bash
# 現在使用しているトークンの確認
npm token list

# 新しい粒度の細かいトークンの生成
# npmjs.comのアカウント設定から実施
```

**推奨事項:**
- CI/CDワークフローで使用しているトークンを見直し
- 新しい粒度の細かいトークンへの移行
- トークンのローテーション戦略の策定

### 2. 2FA設定の更新

**推奨される移行手順:**
1. npmjs.comアカウント設定にアクセス
2. TOTPからWebAuthn/パスキーへ移行
3. 複数のバックアップ認証方法を設定

### 3. 信頼できる公開者(Trusted Publisher/OIDC)の採用検討

**メリット:**
- 長期間有効なトークンが不要になる
- 短期間の自動生成されるトークンを使用
- セキュリティリスクの大幅な削減

**対応プラットフォーム:**
- GitHub Actions
- GitLab CI
- その他のOIDC対応CI/CDシステム

## セキュリティ上の理由

### なぜこれらの変更が必要なのか

1. **長寿命トークンのリスク**
   - サプライチェーン攻撃の主要な侵入経路
   - 漏洩した場合の影響範囲が広い
   - 検出と対応が遅れる可能性

2. **クラシックトークンの脆弱性**
   - 粒度の細かい権限管理ができない
   - 監査とトレーサビリティが不十分

3. **TOTPの限界**
   - フィッシング攻撃に対して脆弱
   - WebAuthn/パスキーの方がより安全

## 移行のベストプラクティス

### CI/CDワークフローの更新

```yaml
# GitHub Actionsの例
# 新しい粒度の細かいトークンを使用
- name: Publish to npm
  run: npm publish
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### トークン管理のベストプラクティス

1. **定期的なローテーション**: 90日以内にトークンを更新
2. **最小権限の原則**: 必要最小限の権限のみ付与
3. **監査ログの確認**: トークンの使用状況を定期的に監視
4. **シークレット管理ツールの活用**: 安全なトークン保管

### 信頼できる公開者への移行例

```yaml
# GitHub Actionsでの信頼できる公開者の使用例
name: Publish Package
on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC認証に必要
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm publish --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## まとめ

これらの変更は、npmエコシステム全体のセキュリティを強化するための重要な取り組みです。開発者とチームは、2025年11月中旬までに以下の対応を完了する必要があります:

- [ ] クラシックトークンの特定と移行
- [ ] 新しい粒度の細かいトークンへの更新
- [ ] CI/CDワークフローの見直しと修正
- [ ] WebAuthn/パスキーへの2FA移行
- [ ] 信頼できる公開者(OIDC)の採用検討

早めの対応により、パッケージ公開ワークフローの中断を回避できます。

---

**参考リンク:**
- [GitHub公式アナウンスメント](https://github.blog/changelog/2025-09-29-strengthening-npm-security-important-changes-to-authentication-and-token-management/)
- [npm公式ドキュメント - アクセストークン](https://docs.npmjs.com/about-access-tokens)
- [npm公式ドキュメント - 信頼できる公開者](https://docs.npmjs.com/generating-provenance-statements)
